<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Body Measurement Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        .screen { display: none; }
        .active { display: flex; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #camera-feed {
            transform: scaleX(-1); /* Mirror the camera feed */
        }
        #pose-outline-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-6xl mx-auto bg-gray-800 rounded-2xl shadow-2xl overflow-hidden relative pb-12">

        <!-- Loading Screen -->
        <div id="loading-screen" class="screen active flex-col items-center justify-center h-[80vh]">
            <div class="loader"></div>
            <p class="mt-4 text-lg text-gray-400">Initializing AI Analysis Engine...</p>
        </div>

        <!-- Login Screen -->
        <div id="login-screen" class="screen flex-col items-center justify-center h-[80vh] p-8 text-center">
            <h1 class="text-5xl font-bold text-white mb-4">Body Composition AI</h1>
            <p class="text-xl text-gray-400 mb-12 max-w-2xl">Sign in with your Google account to save and manage your personal body measurement profiles.</p>
            <button id="google-login-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-transform transform hover:scale-105 shadow-lg flex items-center gap-3">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.222 0-9.519-3.487-11.181-8.264l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.012 36.49 44 30.638 44 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                Sign In with Google
            </button>
        </div>

        <!-- Profile Dashboard Screen -->
        <div id="profile-dashboard-screen" class="screen flex-col items-center justify-start h-auto min-h-[80vh] p-8">
             <div class="w-full max-w-3xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Your Profiles</h2>
                    <button class="sign-out-btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm flex items-center gap-2">
                        <i data-lucide="log-out"></i> Sign Out
                    </button>
                </div>
                <button id="go-to-new-profile-from-dashboard" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-lg mb-6">
                    + Add New Profile
                </button>
                <div id="profile-list" class="space-y-3"></div>
            </div>
        </div>

        <!-- New Profile Screen -->
        <div id="new-profile-screen" class="screen flex-col items-center justify-center h-auto p-8">
            <div class="w-full max-w-lg">
                <button id="back-to-dashboard-from-new" class="mb-6 text-gray-400 hover:text-white flex items-center gap-2">
                    <i data-lucide="arrow-left"></i> Back to Profiles
                </button>
                <h2 class="text-3xl font-bold mb-6 text-center">Create New Profile</h2>
                <form id="new-profile-form" class="space-y-4">
                    <input type="text" id="name" placeholder="Name" class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    <select id="gender" class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        <option value="" disabled selected>Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <input type="number" id="height" placeholder="Height (cm)" class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" required step="any">
                        <input type="number" id="weight" placeholder="Weight (kg)" class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" required step="any">
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-lg mt-4">Save and Start Scan</button>
                </form>
            </div>
        </div>
        
        <!-- NEW: Camera Capture Screen -->
        <div id="camera-screen" class="screen flex-col items-center justify-center h-[90vh] p-4 bg-black">
            <div class="w-full max-w-md h-full flex flex-col items-center justify-between">
                <div id="camera-instructions" class="text-center p-4">
                    <h2 id="pose-title" class="text-2xl font-bold"></h2>
                    <p id="pose-description" class="text-gray-400"></p>
                </div>
                <div class="relative w-full aspect-[3/4] rounded-2xl overflow-hidden bg-gray-900">
                    <video id="camera-feed" class="w-full h-full object-cover" playsinline autoplay muted></video>
                    <svg id="pose-outline-svg" viewBox="0 0 300 400" preserveAspectRatio="xMidYMid meet"></svg>
                    <canvas id="capture-canvas" class="hidden"></canvas>
                </div>
                <div class="w-full flex items-center justify-around p-4">
                     <button id="back-to-dashboard-from-camera" class="bg-gray-700 hover:bg-gray-600 text-white font-bold p-3 rounded-full"><i data-lucide="arrow-left"></i></button>
                    <button id="capture-btn" class="bg-white text-black w-20 h-20 rounded-full border-4 border-gray-500 hover:bg-gray-200 transition-all"></button>
                    <div class="w-12 h-12"></div> <!-- Spacer -->
                </div>
            </div>
        </div>

        <!-- Detailed Report Screen -->
        <div id="report-screen" class="screen flex-col h-auto min-h-[80vh] p-8 space-y-6">
             <div id="analysis-loader" class="absolute inset-0 bg-gray-900 bg-opacity-90 z-50 flex-col items-center justify-center">
                <div class="loader"></div>
                <p id="analysis-status-text" class="mt-4 text-lg text-gray-400">AI is generating your report...</p>
            </div>
            <div class="w-full max-w-5xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-4xl font-bold">Analysis Report</h2>
                    <button id="back-to-camera-from-report" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg text-sm flex items-center gap-2"><i data-lucide="camera"></i> New Scan</button>
                </div>
                <section>
                    <h3 class="text-2xl font-semibold mb-4 mt-6">Measurements</h3>
                    <div id="results-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center"></div>
                </section>
                <div id="in-depth-analysis-section" class="space-y-6">
                    <button id="get-in-depth-analysis-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg text-lg">Get In-Depth AI Analysis</button>
                    <div id="in-depth-loader" class="hidden flex-col items-center justify-center"><div class="loader"></div><p class="mt-2 text-gray-400">Generating analysis...</p></div>
                    <div id="in-depth-content" class="hidden space-y-6">
                        <section>
                            <h3 class="text-2xl font-semibold mb-4 mt-6">Body Type Analysis</h3>
                            <div class="bg-gray-700 p-6 rounded-lg">
                                <h4 id="body-type-title" class="text-xl font-bold text-indigo-400 mb-2"></h4>
                                <p id="body-type-description" class="text-gray-300"></p>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
        </div>
        
        <footer class="absolute bottom-0 left-0 right-0 p-4 text-center text-gray-500 text-sm">
            Made by <a href="https://www.linkedin.com/in/satya-kulthe/" target="_blank" class="text-indigo-400 hover:underline">Satya Kulthe</a>
        </footer>
    </div>

    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center p-4">
        <div class="bg-gray-700 p-8 rounded-2xl shadow-xl max-w-sm w-full text-center border border-gray-600">
            <p id="modal-message" class="mb-6 text-lg">Message goes here.</p>
            <div id="modal-buttons" class="flex justify-center gap-4">
                 <button id="modal-close-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-8 rounded-lg">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBjU3yOJUIrN_cWsSdjyV067jWLGPsjHUI", authDomain: "body-analyser8860.firebaseapp.com", projectId: "body-analyser8860", storageBucket: "body-analyser8860.appspot.com", messagingSenderId: "412432296504", appId: "1:412432296504:web:481c0ccd99e0f1645414cd", measurementId: "G-6YF20DVRZE" };
        const GEMINI_API_KEY = "AIzaSyBzsQTdqE19YG5tFXcN_zhpGgm_2J_-b6Y";

        let app, db, auth, userId, currentProfile = null, lastCalculatedMeasurements = null;
        const imageFiles = { front: null, side: null, back: null };
        let currentPose = 'front';
        let stream;

        const screens = { loading: document.getElementById('loading-screen'), login: document.getElementById('login-screen'), dashboard: document.getElementById('profile-dashboard-screen'), newProfile: document.getElementById('new-profile-screen'), camera: document.getElementById('camera-screen'), report: document.getElementById('report-screen'), };
        const modal = document.getElementById('custom-modal'); const modalMessage = document.getElementById('modal-message'); const modalButtons = document.getElementById('modal-buttons');
        const newProfileForm = document.getElementById('new-profile-form'); const profileList = document.getElementById('profile-list');
        const resultsGrid = document.getElementById('results-grid'); const analysisLoader = document.getElementById('analysis-loader'); const analysisStatusText = document.getElementById('analysis-status-text');
        const getInDepthAnalysisBtn = document.getElementById('get-in-depth-analysis-btn'); const inDepthLoader = document.getElementById('in-depth-loader'); const inDepthContent = document.getElementById('in-depth-content');
        const video = document.getElementById('camera-feed'); const poseSvg = document.getElementById('pose-outline-svg'); const captureCanvas = document.getElementById('capture-canvas'); const captureBtn = document.getElementById('capture-btn');
        const poseTitle = document.getElementById('pose-title'); const poseDescription = document.getElementById('pose-description');

        const POSE_DATA = {
            front: {
                title: "Front Pose",
                description: "Face the camera, feet shoulder-width apart, arms slightly out.",
                svg: `<path d="M150 40 C135 40 130 50 130 60 L125 100 C110 105 100 120 105 140 L115 190 L105 200 L100 220 C95 230 100 240 110 240 L115 235 L120 380 H140 L140 250 L160 250 L160 380 H180 L185 235 L190 240 C200 240 205 230 200 220 L195 200 L185 190 L195 140 C200 120 190 105 175 100 L170 60 C170 50 165 40 150 40 Z" fill="rgba(255,255,255,0.2)" stroke="rgba(255,255,255,0.7)" stroke-width="2"/>`
            },
            side: {
                title: "Side Pose",
                description: "Turn 90 degrees to your right. Keep your arms straight at your sides.",
                svg: `<path d="M150 40 C160 40 165 50 165 60 L160 90 C165 100 170 120 165 140 L160 180 L165 240 L160 380 H140 L135 240 L130 160 C125 120 125 90 140 80 L140 60 C140 50 140 40 150 40 Z" fill="rgba(255,255,255,0.2)" stroke="rgba(255,255,255,0.7)" stroke-width="2"/>`
            },
            back: {
                title: "Back Pose",
                description: "Turn around, facing away from the camera. Stand straight.",
                svg: `<path d="M150 40 C135 40 130 50 130 60 L125 100 C110 105 100 120 105 140 L115 190 L105 200 L100 220 C95 230 100 240 110 240 L115 235 L120 380 H140 L140 250 L160 250 L160 380 H180 L185 235 L190 240 C200 240 205 230 200 220 L195 200 L185 190 L195 140 C200 120 190 105 175 100 L170 60 C170 50 165 40 150 40 Z" fill="rgba(255,255,255,0.2)" stroke="rgba(255,255,255,0.7)" stroke-width="2"/>`
            }
        };

        function showScreen(screenName) { Object.values(screens).forEach(s => s.classList.remove('active')); screens[screenName].classList.add('active'); if (screenName !== 'camera') stopCamera(); }
        function showModal(message) { modalMessage.textContent = message; modal.style.display = 'flex'; document.getElementById('modal-close-btn').onclick = () => { modal.style.display = 'none'; }; }

        document.getElementById('google-login-btn').addEventListener('click', handleGoogleLogin);
        document.querySelectorAll('.sign-out-btn').forEach(btn => btn.addEventListener('click', handleSignOut));
        document.getElementById('go-to-new-profile-from-dashboard').addEventListener('click', () => showScreen('newProfile'));
        document.getElementById('back-to-dashboard-from-new').addEventListener('click', () => showScreen('dashboard'));
        document.getElementById('back-to-dashboard-from-camera').addEventListener('click', () => showScreen('dashboard'));
        document.getElementById('back-to-camera-from-report').addEventListener('click', () => startCameraWorkflow());
        getInDepthAnalysisBtn.addEventListener('click', handleInDepthAnalysis);
        captureBtn.addEventListener('click', handleCapture);

        async function initialize() { try { app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); onAuthStateChanged(auth, (user) => { if (user) { userId = user.uid; loadProfiles(); showScreen('dashboard'); } else { userId = null; currentProfile = null; showScreen('login'); } }); lucide.createIcons(); } catch (error) { console.error("Firebase init failed:", error); screens.loading.innerHTML = `<p class="text-red-500">Connection Error.</p>`; } }
        async function handleGoogleLogin() { const provider = new GoogleAuthProvider(); try { await signInWithPopup(auth, provider); } catch (error) { console.error("Sign-In Error:", error); showModal("Could not sign in."); } }
        async function handleSignOut() { try { await signOut(auth); } catch (error) { console.error("Sign Out Error:", error); } }
        window.onload = initialize;

        newProfileForm.addEventListener('submit', async (e) => { e.preventDefault(); if (!userId) { showModal("You must be signed in."); return; } const profileData = { name: document.getElementById('name').value, gender: document.getElementById('gender').value, height: parseFloat(document.getElementById('height').value), weight: parseFloat(document.getElementById('weight').value) }; try { const appId = 'body-measurement-app'; const docRef = await addDoc(collection(db, `artifacts/${appId}/users/${userId}/profiles`), profileData); currentProfile = { id: docRef.id, ...profileData }; newProfileForm.reset(); startCameraWorkflow(); } catch (error) { console.error("Error adding document: ", error); showModal("Failed to save profile."); } });
        async function loadProfiles() { if (!userId) return; const appId = 'body-measurement-app'; const profilesCol = collection(db, `artifacts/${appId}/users/${userId}/profiles`); const q = query(profilesCol); const profileSnapshot = await getDocs(q); profileList.innerHTML = profileSnapshot.empty ? '<p class="text-center text-gray-500">No profiles found.</p>' : ''; profileSnapshot.forEach((doc) => { const profile = { id: doc.id, ...doc.data() }; const pElem = document.createElement('div'); pElem.className = 'bg-gray-700 p-4 rounded-lg flex justify-between items-center'; pElem.innerHTML = `<div class="cursor-pointer flex-grow"><p class="font-bold text-lg">${profile.name}</p></div><button class="scan-profile-btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg text-sm flex items-center gap-2"><i data-lucide="camera"></i> Scan</button>`; pElem.querySelector('.scan-profile-btn').onclick = () => { currentProfile = profile; startCameraWorkflow(); }; profileList.appendChild(pElem); }); lucide.createIcons(); }

        // --- NEW CAMERA WORKFLOW ---
        async function startCameraWorkflow() {
            showScreen('camera');
            currentPose = 'front';
            imageFiles.front = imageFiles.side = imageFiles.back = null;
            updateCameraUI();
            
            try {
                if (stream) { stream.getTracks().forEach(track => track.stop()); }
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width: 720, height: 960 }, audio: false });
                video.srcObject = stream;
            } catch (err) {
                console.error("Camera access error:", err);
                showModal("Could not access the camera. Please check your browser permissions.");
                showScreen('dashboard');
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }
        
        function updateCameraUI() {
            const data = POSE_DATA[currentPose];
            poseTitle.textContent = data.title;
            poseDescription.textContent = data.description;
            poseSvg.innerHTML = data.svg;
            
            if (currentPose === 'analysis') {
                captureBtn.innerHTML = `<i data-lucide="scan-line"></i>`;
                captureBtn.classList.remove('bg-white');
                captureBtn.classList.add('bg-green-500', 'text-white');
            } else {
                captureBtn.innerHTML = '';
                captureBtn.classList.add('bg-white');
                captureBtn.classList.remove('bg-green-500', 'text-white');
            }
            lucide.createIcons();
        }

        function handleCapture() {
            if (currentPose === 'analysis') {
                runAutomatedAnalysis();
                return;
            }

            const context = captureCanvas.getContext('2d');
            captureCanvas.width = video.videoWidth;
            captureCanvas.height = video.videoHeight;
            context.translate(video.videoWidth, 0);
            context.scale(-1, 1);
            context.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
            
            captureCanvas.toBlob(blob => {
                imageFiles[currentPose] = new File([blob], `${currentPose}.jpg`, { type: 'image/jpeg' });
                
                if (currentPose === 'front') currentPose = 'side';
                else if (currentPose === 'side') currentPose = 'back';
                else if (currentPose === 'back') currentPose = 'analysis';

                updateCameraUI();
            }, 'image/jpeg');
        }
        
        async function runAutomatedAnalysis() {
            stopCamera();
            showScreen('report');
            analysisLoader.style.display = 'flex';

            try {
                analysisStatusText.textContent = "Detecting body scale (1/4)...";
                const heightPrompt = `From the front-view image, return ONLY JSON with pixel coordinates for "top_of_head" and "bottom_of_feet".`;
                const heightCoords = await callGeminiVision(imageFiles.front, heightPrompt);
                if (!heightCoords?.top_of_head || !heightCoords?.bottom_of_feet) throw new Error("Could not determine height from the front photo.");

                analysisStatusText.textContent = "Analyzing front view (2/4)...";
                const frontPrompt = `From the front-view image, return ONLY JSON with pixel coordinates for: shoulder_left, shoulder_right, chest_left, chest_right, waist_left, waist_right, hip_left, hip_right.`;
                const frontCoords = await callGeminiVision(imageFiles.front, frontPrompt);
                if (!frontCoords) throw new Error("Could not identify landmarks on the front photo.");

                analysisStatusText.textContent = "Analyzing side view (3/4)...";
                const sidePrompt = `From the side-view image, return ONLY JSON with pixel coordinates for: chest_front, chest_back, waist_front, waist_back, hip_front, hip_back.`;
                const sideCoords = await callGeminiVision(imageFiles.side, sidePrompt);
                if (!sideCoords) throw new Error("Could not determine body depth from the side photo.");
                
                analysisStatusText.textContent = "Analyzing back view (4/4)...";
                const backPrompt = `From the back-view image, return ONLY JSON with pixel coordinates for shoulder_left_back and shoulder_right_back.`;
                const backCoords = await callGeminiVision(imageFiles.back, backPrompt);

                analysisStatusText.textContent = "Calculating measurements...";
                const allCoords = { ...heightCoords, ...frontCoords, ...sideCoords, ...backCoords };
                const pixelHeight = Math.abs(allCoords.top_of_head.y - allCoords.bottom_of_feet.y);
                const pixelsPerCm = pixelHeight > 0 ? pixelHeight / currentProfile.height : 0;
                if (pixelsPerCm === 0) throw new Error("Could not calculate body scale.");

                const measurements = calculateMeasurements(allCoords, pixelsPerCm);
                lastCalculatedMeasurements = measurements;
                displayBasicReport(measurements);

            } catch (error) {
                 console.error("Automated analysis failed:", error);
                 showModal(error.message || "An unexpected error occurred during analysis.");
                 showScreen('camera'); // Go back to camera on failure
            } finally {
                analysisLoader.style.display = 'none';
            }
        }
        
        function resizeAndEncodeImage(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = (e) => { const img = new Image(); img.onload = () => { const canvas = document.createElement('canvas'); let { width, height } = img; const maxWidth = 512; if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height); const base64 = canvas.toDataURL(file.type).split(',')[1]; resolve({ mimeType: file.type, base64 }); }; img.onerror = reject; img.src = e.target.result; }; reader.onerror = reject; reader.readAsDataURL(file); }); }

        async function callGeminiVision(imageFile, prompt) {
            if (!imageFile) return null;
            const imageData = await resizeAndEncodeImage(imageFile);
            const payload = { contents: [{ role: "user", parts: [ { text: prompt }, { inlineData: { mimeType: imageData.mimeType, data: imageData.base64 } } ] }], generationConfig: { responseMimeType: "application/json", temperature: 0 } };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro-vision:generateContent?key=${GEMINI_API_KEY}`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (response.ok) {
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]) {
                        try { return JSON.parse(result.candidates[0].content.parts[0].text); } catch (jsonError) { console.error("Failed to parse JSON:", jsonError); return null; }
                    }
                } else { const errorText = await response.text(); console.error(`API Error:`, response.status, errorText); if (errorText.includes("API key not valid")) showModal("API Key Error: Key is not valid."); }
            } catch (error) { console.error(`Fetch error:`, error); }
            return null;
        }

        function calculateMeasurements(coords, pixelsPerCm) {
            const measurements = {}; const pi = Math.PI;
            const getCircumference = (w, d) => { if (!w || !d || w <= 0 || d <= 0) return 0; const a = w / 2, b = d / 2; return pi * (3 * (a + b) - Math.sqrt((3 * a + b) * (a + 3 * b))); };
            const pxToCm = (px) => px / pixelsPerCm;
            measurements["Shoulder Width"] = pxToCm(Math.abs((coords?.shoulder_left?.x || 0) - (coords?.shoulder_right?.x || 0)));
            measurements["Chest"] = getCircumference(pxToCm(Math.abs((coords?.chest_left?.x || 0) - (coords?.chest_right?.x || 0))), pxToCm(Math.abs((coords?.chest_front?.x || 0) - (coords?.chest_back?.x || 0))));
            measurements["Waist"] = getCircumference(pxToCm(Math.abs((coords?.waist_left?.x || 0) - (coords?.waist_right?.x || 0))), pxToCm(Math.abs((coords?.waist_front?.x || 0) - (coords?.waist_back?.x || 0))));
            measurements["Hip"] = getCircumference(pxToCm(Math.abs((coords?.hip_left?.x || 0) - (coords?.hip_right?.x || 0))), pxToCm(Math.abs((coords?.hip_front?.x || 0) - (coords?.hip_back?.x || 0))));
            return measurements;
        }

        async function getAiPhysiqueAnalysis(measurements) {
            const prompt = `Given these measurements for a ${currentProfile.gender}, analyze physique for somatotype and sports recommendations. Return ONLY valid JSON with 'bodyType' ({ "type": "...", "description": "..." }) and 'sportsRecommendation' ({ "recommended": ["..."], "caution": ["..."] }). Data: ${JSON.stringify(measurements, null, 2)}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", temperature: 0.2 } };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`;
            try { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (response.ok) { const result = await response.json(); if (result.candidates?.[0]?.content?.parts?.[0]) { return JSON.parse(result.candidates[0].content.parts[0].text); } } else { console.error(`Analysis API Error:`, response.status, await response.text()); } } catch (error) { console.error(`Analysis Fetch error:`, error); } return null;
        }
        
        async function handleInDepthAnalysis() {
            if (!lastCalculatedMeasurements) return;
            getInDepthAnalysisBtn.classList.add('hidden');
            inDepthLoader.style.display = 'flex';
            const analysis = await getAiPhysiqueAnalysis(lastCalculatedMeasurements);
            if (analysis?.bodyType && analysis?.sportsRecommendation) {
                document.getElementById('body-type-title').textContent = analysis.bodyType.type; document.getElementById('body-type-description').textContent = analysis.bodyType.description;
                document.getElementById('recommended-sports-list').innerHTML = analysis.sportsRecommendation.recommended.map(s => `<li>${s}</li>`).join('');
                document.getElementById('caution-sports-list').innerHTML = analysis.sportsRecommendation.caution.map(s => `<li>${s}</li>`).join('');
                inDepthContent.classList.remove('hidden');
            } else { showModal("Could not generate the in-depth analysis."); getInDepthAnalysisBtn.classList.remove('hidden'); }
            inDepthLoader.style.display = 'none';
        }

        function displayBasicReport(measurements) {
            resultsGrid.innerHTML = '';
            for (const [key, value] of Object.entries(measurements)) {
                const item = document.createElement('div');
                item.className = 'bg-gray-800 p-4 rounded-lg';
                item.innerHTML = `<p class="text-sm text-gray-400">${key}</p><p class="text-2xl font-bold">${Number(value).toFixed(1)} <span class="text-base font-normal text-gray-500">cm</span></p>`;
                resultsGrid.appendChild(item);
            }
            inDepthContent.classList.add('hidden');
            getInDepthAnalysisBtn.classList.remove('hidden');
        }

    </script>
</body>
</html>

